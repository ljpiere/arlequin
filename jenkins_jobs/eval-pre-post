pipeline {
  agent any
  environment {
    TRAINING_LOG = '/tmp/arlequin-logs/training_log.csv'
    DRIFT_LOG    = '/tmp/arlequin-logs/drift_log.csv'
  }
  stages {
    stage('Resolve containers') {
      steps {
        sh '''
          set -eu
          CID_PY=$(docker ps -qf "label=com.docker.compose.service=pyspark-client" || true)
          if [ -z "$CID_PY" ]; then CID_PY=$(docker ps -qf "name=pyspark-client"); fi
          [ -n "$CID_PY" ] || { echo "[ERROR] pyspark-client no encontrado"; docker ps; exit 1; }
          echo "$CID_PY" > .cid_py
        '''
      }
    }
    stage('Prep evaluator deps') {
      steps {
        sh '''
          set -eu
          CID_PY=$(cat .cid_py)
          docker exec -i "$CID_PY" sh -lc 'python3 - <<PY
try:
 import scipy, pandas, numpy
 print("eval deps OK")
except Exception:
 raise SystemExit(1)
PY' || docker exec -i "$CID_PY" sh -lc 'python3 -m pip install --no-cache-dir -r /scripts/requirements-drift.txt'
        '''
      }
    }
    stage('Eval pre-training metrics') {
      steps {
        sh '''
          set -eu
          PHASE="pre"
          CID_PY=$(cat .cid_py)
          METRICS_DIR="$WORKSPACE/metrics"
          mkdir -p "$METRICS_DIR"
          docker exec -i "$CID_PY" sh -lc "[ -f ${TRAINING_LOG} ] || { echo '[ERROR] training_log.csv no existe dentro del contenedor'; exit 2; }"
          OUT_PATH="/tmp/arlequin-logs/mannwhitney_results_${PHASE}.csv"
          docker exec -i "$CID_PY" sh -lc "python3 /scripts/eval_stats.py --input ${TRAINING_LOG} --drift-input ${DRIFT_LOG} --out ${OUT_PATH} --fdr || true"
          docker cp "$CID_PY":"$OUT_PATH" "$METRICS_DIR/" 2>/dev/null || true
          docker cp "$CID_PY":"${TRAINING_LOG}" "$METRICS_DIR/training_log_${PHASE}.csv" 2>/dev/null || true
          docker cp "$CID_PY":"${DRIFT_LOG}" "$METRICS_DIR/drift_log_${PHASE}.csv" 2>/dev/null || true
        '''
      }
    }
    stage('Eval post-training metrics') {
      steps {
        sh '''
          set -eu
          PHASE="post"
          CID_PY=$(cat .cid_py)
          METRICS_DIR="$WORKSPACE/metrics"
          mkdir -p "$METRICS_DIR"
          docker exec -i "$CID_PY" sh -lc "[ -f ${TRAINING_LOG} ] || { echo '[ERROR] training_log.csv no existe dentro del contenedor'; exit 2; }"
          OUT_PATH="/tmp/arlequin-logs/mannwhitney_results_${PHASE}.csv"
          docker exec -i "$CID_PY" sh -lc "python3 /scripts/eval_stats.py --input ${TRAINING_LOG} --drift-input ${DRIFT_LOG} --out ${OUT_PATH} --fdr || true"
          docker cp "$CID_PY":"$OUT_PATH" "$METRICS_DIR/" 2>/dev/null || true
          docker cp "$CID_PY":"${TRAINING_LOG}" "$METRICS_DIR/training_log_${PHASE}.csv" 2>/dev/null || true
          docker cp "$CID_PY":"${DRIFT_LOG}" "$METRICS_DIR/drift_log_${PHASE}.csv" 2>/dev/null || true
        '''
      }
    }
  }
  post {
    always {
      echo 'Evaluation-only pipeline finished.'
    }
  }
}
